#!/bin/sh
# Pre-commit hook: format staged files and check documentation sync

echo "Running pre-commit checks..."

# Get list of staged files BEFORE formatting
STAGED_PY=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)
STAGED_TS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)

# Format only staged Python files
if [ -n "$STAGED_PY" ]; then
  echo "$STAGED_PY" | xargs uv run ruff format --quiet 2>/dev/null || true
  echo "$STAGED_PY" | xargs uv run ruff check --fix --quiet 2>/dev/null || true
  # Re-stage only the files that were originally staged
  echo "$STAGED_PY" | xargs git add
fi

# Format only staged TypeScript/JavaScript files
if [ -n "$STAGED_TS" ]; then
  (cd frontend && echo "$STAGED_TS" | sed 's|^frontend/||' | xargs pnpm exec ultracite fix --quiet 2>/dev/null || true)
  # Re-stage only the files that were originally staged
  echo "$STAGED_TS" | xargs git add
fi

# Documentation sync check (warn only)
CODE_PATTERNS="docker-compose\.yml|Makefile|pyproject\.toml|package\.json"
DOC_FILES="README\.md|docs/|CLAUDE\.md"

if git diff --cached --name-only | grep -qE "$CODE_PATTERNS"; then
  if ! git diff --cached --name-only | grep -qE "$DOC_FILES"; then
    echo ""
    echo "⚠️  Config files modified but no documentation updated."
    echo "   Changed: $(git diff --cached --name-only | grep -E "$CODE_PATTERNS" | tr '\n' ' ')"
    echo "   Consider checking if README.md or docs/ need updates."
    echo ""
  fi
fi

echo "Pre-commit complete."
